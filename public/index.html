<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Freedom</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --tg-bg: #0e1621;
            --tg-sidebar: #17212b;
            --tg-active: #2b5278;
            --tg-accent: #3390ec;
            --tg-text: #ffffff;
            --tg-muted: #7f91a4;
            --tg-msg-in: #182533;
            --tg-msg-out: #2b5278;
            --tg-border: #101921;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { background: var(--tg-bg); color: var(--tg-text); height: 100vh; display: flex; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 300px; background: var(--tg-sidebar); border-right: 1px solid var(--tg-border); display: flex; flex-direction: column; position: relative; z-index: 10; }
        .sidebar-header { padding: 15px; display: flex; align-items: center; gap: 15px; }
        .menu-btn { background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%; }
        .menu-btn:hover { background: rgba(255,255,255,0.05); }
        .search-bar { flex: 1; background: var(--tg-bg); border: none; border-radius: 20px; padding: 8px 15px; color: #fff; outline: none; font-size: 14px; }

        /* Chat List Item */
        .chat-item { padding: 10px 15px; display: flex; align-items: center; gap: 12px; background: var(--tg-active); cursor: pointer; }
        .avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #51a5f4, #3390ec); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }

        /* Chat Area */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: #0e1621 url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: soft-light; }
        
        .chat-header { height: 56px; background: var(--tg-sidebar); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; border-bottom: 1px solid var(--tg-border); }
        .chat-info h3 { font-size: 16px; }
        .chat-info span { font-size: 13px; color: var(--tg-accent); }

        /* Messages */
        .messages-container { flex: 1; padding: 15px 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        .msg-group { display: flex; flex-direction: column; max-width: 75%; position: relative; margin-bottom: 4px; }
        .msg-group.out { align-self: flex-end; }
        .msg-group.in { align-self: flex-start; }

        .bubble { padding: 8px 12px; border-radius: 12px; font-size: 15px; line-height: 1.4; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .in .bubble { background: var(--tg-msg-in); border-bottom-left-radius: 4px; }
        .out .bubble { background: var(--tg-msg-out); border-bottom-right-radius: 4px; }
        
        .msg-name { font-size: 13px; font-weight: 600; color: var(--tg-accent); margin-bottom: 2px; }
        .msg-time { font-size: 11px; color: var(--tg-muted); float: right; margin-top: 5px; margin-left: 8px; }

        /* Input Bar */
        .input-bar { background: var(--tg-sidebar); padding: 10px 20px; display: flex; align-items: center; gap: 15px; }
        .attach-btn { fill: var(--tg-muted); cursor: pointer; }
        .message-input { flex: 1; background: none; border: none; color: #fff; font-size: 16px; outline: none; padding: 10px 0; }
        .send-btn { color: var(--tg-accent); border: none; background: none; font-weight: bold; cursor: pointer; font-size: 15px; }

        /* Settings Panel */
        .settings-overlay { position: absolute; inset: 0; background: var(--tg-sidebar); z-index: 100; transform: translateX(-100%); transition: 0.3s ease; display: flex; flex-direction: column; }
        .settings-overlay.open { transform: translateX(0); }
        .settings-header { padding: 15px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--tg-border); }
        .settings-content { padding: 20px; flex: 1; overflow-y: auto; }
        .profile-edit { text-align: center; margin-bottom: 30px; }
        .profile-edit .avatar-large { width: 100px; height: 100px; margin: 0 auto 15px; font-size: 36px; }
        .s-input-group { margin-bottom: 20px; }
        .s-input-group label { display: block; color: var(--tg-accent); font-size: 13px; margin-bottom: 8px; font-weight: bold; }
        .s-input { width: 100%; background: var(--tg-bg); border: 1px solid var(--tg-border); padding: 12px; color: #fff; border-radius: 8px; outline: none; }

        svg { fill: var(--tg-muted); width: 24px; height: 24px; }
        .active-svg { fill: var(--tg-accent); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <button class="menu-btn" onclick="toggleSettings(true)">
                <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </button>
            <input type="text" class="search-bar" placeholder="–ü–æ–∏—Å–∫">
        </div>
        
        <div class="chat-item">
            <div class="avatar" id="sideAva">F</div>
            <div style="flex:1">
                <div style="font-weight: bold; font-size: 15px;">Freedom Global</div>
                <div style="color: var(--tg-muted); font-size: 13px;" id="dhStatus">DH: –û–∂–∏–¥–∞–Ω–∏–µ...</div>
            </div>
        </div>

        <div class="settings-overlay" id="settingsPanel">
            <div class="settings-header">
                <button class="menu-btn" onclick="toggleSettings(false)">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            </div>
            <div class="settings-content">
                <div class="profile-edit">
                    <div class="avatar avatar-large" id="setAva">U</div>
                    <button style="background:none; border:none; color:var(--tg-accent); cursor:pointer">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
                </div>
                <div class="s-input-group">
                    <label>–í–∞—à –Ω–∏–∫–Ω–µ–π–º</label>
                    <input type="text" id="nickInp" class="s-input" oninput="saveProfile()">
                </div>
                <div style="background: rgba(51, 144, 236, 0.05); padding: 15px; border-radius: 10px; font-size: 13px; color: var(--tg-muted);">
                    –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã —Å–∫–≤–æ–∑–Ω—ã–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º –î–∏—Ñ—Ñ–∏-–•–µ–ª–ª–º–∞–Ω–∞. –ö–ª—é—á–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∫–∏–¥–∞—é—Ç –±—Ä–∞—É–∑–µ—Ä.
                </div>
            </div>
        </div>
    </div>

    <div class="main-chat">
        <div class="chat-header">
            <div class="chat-info">
                <h3>Freedom Global Chat</h3>
                <span id="netStatus">–æ–∂–∏–¥–∞–Ω–∏–µ —Å–µ—Ç–∏...</span>
            </div>
            <div class="encryption-badge" style="font-size: 11px; color: var(--tg-muted);">E2EE SECURED</div>
        </div>

        <div class="messages-container" id="msgBox"></div>

        <div class="input-bar">
            <div class="attach-btn">
                <svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4s-4 1.79-4 4v12.5c0 3.31 2.69 6 6 6s6-2.69 6-6V6h-1.5z"/></svg>
            </div>
            <input type="text" id="mainMsgInput" class="message-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button class="send-btn" onclick="send()">–û–¢–ü–†–ê–í–ò–¢–¨</button>
        </div>
    </div>

    <script>
        const socket = io();
        let sharedSecret = null;

        // --- DH ALGORITHM ---
        const P = 0xFFFFFFFB; 
        const G = 2;
        const privKey = Math.floor(Math.random() * 1000000);
        const pubKey = BigInt(G) ** BigInt(privKey) % BigInt(P);

        socket.on('connect', () => {
            document.getElementById('netStatus').textContent = '–≤ —Å–µ—Ç–∏';
            socket.emit('dh-init', { key: pubKey.toString() });
        });

        socket.on('dh-init', (data) => {
            const remotePubKey = BigInt(data.key);
            sharedSecret = remotePubKey ** BigInt(privKey) % BigInt(P);
            document.getElementById('dhStatus').textContent = '–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ';
            document.getElementById('dhStatus').style.color = '#4caf50';
        });

        // --- CRYPTO ---
        function encrypt(t) {
            if(!sharedSecret) return t;
            return CryptoJS.AES.encrypt(t, sharedSecret.toString()).toString();
        }
        function decrypt(c) {
            if(!sharedSecret) return c;
            try {
                const b = CryptoJS.AES.decrypt(c, sharedSecret.toString());
                return b.toString(CryptoJS.enc.Utf8) || "üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ";
            } catch(e) { return "üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ"; }
        }

        // --- ACTIONS ---
        function send() {
            const inp = document.getElementById('mainMsgInput');
            if(!inp.value.trim()) return;
            
            const nick = localStorage.getItem('f_nick') || 'User';
            const text = inp.value.trim();
            
            socket.emit('chat message', { text: encrypt(text), nick: nick });
            render(text, 'out', '–í—ã');
            inp.value = '';
        }

        socket.on('chat message', (data) => {
            render(decrypt(data.text), 'in', data.nick);
        });

        function render(text, type, name) {
            const box = document.getElementById('msgBox');
            const group = document.createElement('div');
            group.className = `msg-group ${type}`;
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            group.innerHTML = `
                ${type === 'in' ? `<div class="msg-name">${name}</div>` : ''}
                <div class="bubble">
                    ${text}
                    <span class="msg-time">${time}</span>
                </div>
            `;
            box.appendChild(group);
            box.scrollTop = box.scrollHeight;
        }

        // --- UI & PROFILE ---
        function toggleSettings(open) {
            document.getElementById('settingsPanel').classList.toggle('open', open);
        }

        function saveProfile() {
            const nick = document.getElementById('nickInp').value;
            localStorage.setItem('f_nick', nick);
            document.getElementById('setAva').textContent = nick.charAt(0).toUpperCase() || 'U';
            document.getElementById('sideAva').textContent = nick.charAt(0).toUpperCase() || 'U';
        }

        window.onload = () => {
            const savedNick = localStorage.getItem('f_nick') || 'Anonymous';
            document.getElementById('nickInp').value = savedNick;
            saveProfile();
        };

        document.getElementById('mainMsgInput').onkeydown = e => { if(e.key === 'Enter') send(); };
    </script>
</body>
</html>        .message.in { background-color: var(--message-in); align-self: flex-start; border-bottom-left-radius: 2px; }
        .message.out { background-color: var(--message-out); align-self: flex-end; border-bottom-right-radius: 2px; }
        
        /* –í–í–û–î */
        .input-area { background-color: var(--bg-panel); padding: 10px 20px; display: flex; align-items: center; gap: 12px; }
        .input-field { flex: 1; background: var(--bg-dark); border: none; padding: 12px 18px; border-radius: 22px; color: #fff; outline: none; }
        
        /* –ú–û–î–ê–õ–ö–ê –ù–ê–°–¢–†–û–ï–ö */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-panel); width: 400px; border-radius: 15px; overflow: hidden; }
        .settings-list { padding: 20px; }
        .s-item { margin-bottom: 15px; }
        .s-item label { display: block; font-size: 12px; color: var(--success); margin-bottom: 5px; text-transform: uppercase; }
        .s-item input { width: 100%; background: var(--bg-dark); border: 1px solid var(--border); padding: 10px; color: #fff; border-radius: 8px; outline: none; }

        .btn-icon { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; display: flex; align-items: center; }
        svg { fill: var(--text-muted); width: 24px; height: 24px; }
        .rec-active { fill: var(--danger) !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <button class="btn-icon" onclick="toggleModal(true)">
                <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </button>
            <input type="text" class="search-bar" placeholder="–ü–æ–∏—Å–∫">
        </div>
        <div style="padding: 20px; color: var(--text-muted); font-size: 13px; text-align: center;">
            Freedom Messenger<br>–°–∫–≤–æ–∑–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <div class="header-info">
                <h2>Freedom Global Chat</h2>
                <span id="netStatus">–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </div>
        </div>

        <div class="messages" id="msgBox"></div>

        <div class="input-area">
            <input type="text" id="msgInput" class="input-field" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button class="btn-icon" id="sendBtn" style="display:none" onclick="sendMsg()">
                <svg style="fill:var(--success)" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
            <button class="btn-icon" id="micBtn" onclick="toggleMic()">
                <svg id="micIcon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
            </button>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <button onclick="toggleModal(false)" style="background:none; border:none; color:#fff; cursor:pointer;">‚úï</button>
            </div>
            <div class="settings-list">
                <div class="s-item">
                    <label>–í–∞—à –Ω–∏–∫</label>
                    <input type="text" id="nickInp" placeholder="–ù–∞–ø—Ä. Pavel">
                </div>
                <div class="s-item">
                    <label>–ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (AES)</label>
                    <input type="password" id="cryptoInp" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥">
                </div>
                <button onclick="saveSettings()" style="width:100%; padding:12px; background:var(--success); border:none; color:#fff; border-radius:8px; cursor:pointer; font-weight:bold;">–°–û–•–†–ê–ù–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <script>
        // –¢–í–û–Ø –ù–û–í–ê–Ø –°–°–´–õ–ö–ê
        const SERVER_URL = 'https://hdjdwldlckkc-production.up.railway.app';
        const socket = io(SERVER_URL);
        
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];

        // –õ–æ–≥–∏–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
        const getSecret = () => document.getElementById('cryptoInp').value || 'default_freedom_key';
        const encrypt = (text) => CryptoJS.AES.encrypt(text, getSecret()).toString();
        const decrypt = (cipher) => {
            try {
                const bytes = CryptoJS.AES.decrypt(cipher, getSecret());
                return bytes.toString(CryptoJS.enc.Utf8) || "üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ (–Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á)";
            } catch(e) { return "üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ"; }
        };

        socket.on('connect', () => {
            document.getElementById('netStatus').textContent = '–≤ —Å–µ—Ç–∏';
        });

        socket.on('chat message', (data) => {
            const text = decrypt(data.text);
            renderMsg(text, 'in', data.nick, data.isAudio);
        });

        const msgInp = document.getElementById('msgInput');
        msgInp.oninput = () => {
            const hasVal = msgInp.value.trim() !== "";
            document.getElementById('sendBtn').style.display = hasVal ? 'block' : 'none';
            document.getElementById('micBtn').style.display = hasVal ? 'none' : 'block';
        };

        function sendMsg() {
            const text = msgInp.value.trim();
            if(!text) return;
            const nick = document.getElementById('nickInp').value || 'User';
            socket.emit('chat message', { text: encrypt(text), nick: nick });
            renderMsg(text, 'out', '–í—ã');
            msgInp.value = "";
            msgInp.oninput();
        }

        function renderMsg(text, type, author, isAudio = false) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            const name = document.createElement('span');
            name.className = 'msg-author';
            name.textContent = author;
            div.appendChild(name);

            if(isAudio) {
                const aud = document.createElement('audio');
                aud.src = text; aud.controls = true; aud.style.width = "200px";
                div.appendChild(aud);
            } else {
                const t = document.createElement('div');
                t.textContent = text;
                div.appendChild(t);
            }
            document.getElementById('msgBox').appendChild(div);
            document.getElementById('msgBox').scrollTop = document.getElementById('msgBox').scrollHeight;
        }

        async function toggleMic() {
            const icon = document.getElementById('micIcon');
            if(!isRecording) {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                isRecording = true;
                icon.classList.add('rec-active');
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        const base64 = reader.result;
                        socket.emit('chat message', { text: encrypt(base64), nick: document.getElementById('nickInp').value, isAudio: true });
                        renderMsg(base64, 'out', '–í—ã', true);
                    };
                };
            } else {
                mediaRecorder.stop();
                isRecording = false;
                icon.classList.remove('rec-active');
            }
        }

        function toggleModal(show) { document.getElementById('settingsModal').style.display = show ? 'flex' : 'none'; }
        
        function saveSettings() {
            localStorage.setItem('f_nick', document.getElementById('nickInp').value);
            localStorage.setItem('f_key', document.getElementById('cryptoInp').value);
            toggleModal(false);
        }

        window.onload = () => {
            document.getElementById('nickInp').value = localStorage.getItem('f_nick') || '';
            document.getElementById('cryptoInp').value = localStorage.getItem('f_key') || '';
        };

        msgInp.onkeydown = e => { if(e.key === 'Enter') sendMsg(); };
    </script>
</body>
</html>

